# Splunk Search Queries – Phishing Click Detection

This document contains the Splunk Processing Language (SPL) queries used to detect phishing click activity during the SOC phishing simulation.

All logs are collected from the `sysmon` index.

---

## Objective

Detect outbound network connections generated after a phishing email link was clicked.

Primary artifact:
- Sysmon EventCode 3 (Network Connection)

---

## 1️⃣ Retrieve All Network Connection Events

```spl
index=sysmon EventCode=3
```
Purpose:
Displays all network connection events recorded by Sysmon.

## 2️⃣ Filter by Victim Host
```spl
index=sysmon EventCode=3 Image="*msedge.exe"
```
Purpose:
Limits results to the suspected compromised endpoint.

## 3️⃣ Detect Browser-Initiated Connections
```spl
index=sysmon EventCode=3 ComputerName=umut
```
Purpose:
Limits results to the suspected compromised endpoint.

## 3️⃣ Detect Browser-Initiated Connections
```spl
index=sysmon EventCode=3 Image="*msedge.exe"
```
Purpose:
Identifies outbound network connections initiated by Microsoft Edge.

## 4️⃣ Detect Connection to Attacker IP
```spl
index=sysmon EventCode=3 DestinationIp=192.168.1.106
```
Purpose:
Detects direct communication with the attacker-controlled system.

## 5️⃣ High-Confidence Phishing Click Detection
```spl
index=sysmon EventCode=3 Image="*msedge.exe" DestinationIp=192.168.1.106
```
Purpose:
Correlates browser process activity with outbound connection to attacker IP.
This query represents the strongest detection indicator in this lab.

## 6️⃣ Monitor Outbound Web Traffic (HTTP/HTTPS)
```spl
index=sysmon EventCode=3 (DestinationPort=80 OR DestinationPort=443)
```
Purpose:
Monitors outbound web traffic initiated from endpoints.

## 7️⃣ Timeline Reconstruction
```spl
index=sysmon EventCode=3 ComputerName=umut
| sort _time
```
Purpose:
Reconstructs the sequence of events during investigation.

## 8️⃣ Identify Most Contacted IP Addresses
```spl
index=sysmon EventCode=3
| stats count by DestinationIp
| sort -count
```
Purpose:
Provides a statistical overview of outbound connections.

### Detection Summary

Phishing click detection is based on:

Sysmon EventCode 3

Browser process activity (msedge.exe)

Outbound HTTP connection

Destination IP matching attacker system

When these conditions align, phishing click activity is highly probable.
